<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tarjeta - Golftrix</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet" />
  <style>
    body { font-family:'Orbitron',sans-serif; margin:0; padding:12px; background: #f6f6f6; color:#111; }
.container {
  max-width:900px;
  margin:0 auto;
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:12px;
}
.form-card { 
  background:white; 
  border-radius:12px; 
  padding:12px; 
  box-shadow:0 6px 18px rgba(0,0,0,0.08); 
  display:flex; 
  flex-direction:column; 
}
h2 { margin:0 0 12px 0; color:#005600; }
label { display:block; font-weight:700; margin-bottom:6px; }
input[type="number"] { width:100%; padding:8px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px; }
button.save { background:linear-gradient(90deg,#007f00,#00cc44); color:#fff; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800; }
.list { margin-top:12px; max-height:260px; overflow:auto; }
.entry { background:#f0f0f0; padding:8px 10px; border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; }
.small { font-size:0.85rem; color:#666; }
    
    
    .row>div { flex:1; }
    
    /* Móvil: columna única */
@media(max-width:700px){
  .container{ grid-template-columns: 1fr; }
  #hoyosContainer { grid-template-columns: 1fr; }

}
  </style>
</head>
<body>
  <div class="container">
    <div class="form-card" id="formCard">
      <h2>Tu Tarjeta</h2>
      <div id="meta" class="small">Cargando...</div>

      <form id="tarjetaForm">
        <div id="hoyosContainer" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;"></div>
        <button type="submit" class="save" style="margin-top:12px;">Guardar Tarjeta</button>
    </form>



            <div class="list" id="entriesList">
                <!-- entradas guardadas -->
            </div>
            </div>

            <div class="form-card" id="helpCard">
            <h3>Resumen</h3>
            <div id="resumen" class="small">Cargando tarjeta...</div>
            <div style="margin-top:12px;">
                <button id="refrescar" style="padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;">Refrescar</button>
            </div>
            </div>
        </div>

  <script>
    function getQueryParam(n){ const u=new URL(location.href); return u.searchParams.get(n); }
  </script>

  <script type="module">
    import { app, db, auth } from './firebase-config.js';
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import {
      doc, getDoc, updateDoc, arrayUnion, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const tarjetaId = getQueryParam('tarjetaId');
    const juegoId = getQueryParam('juegoId');

    const metaEl = document.getElementById('meta');
    const refrescarBtn = document.getElementById('refrescar');

    if (!tarjetaId) {
      metaEl.textContent = 'Falta tarjetaId en la URL';
      throw new Error('Falta tarjetaId');
    }

    const authInst = getAuth(app);

    let currentTarjeta = null;

    const hoyosContainer = document.getElementById('hoyosContainer');
    const tarjetaForm = document.getElementById('tarjetaForm');

    function renderHoyoInputs(scores) {
    hoyosContainer.innerHTML = '';
    for (let i=1;i<=18;i++) {
        const div = document.createElement('div');
        div.innerHTML = `
        <label for="hoyo${i}">Hoyo ${i}</label>
        <input type="number" id="hoyo${i}" min="0" value="${scores?.find(s=>s.hoyo===i)?.golpes||''}" />
        `;
        hoyosContainer.appendChild(div);
    }
    }



    async function cargarTarjeta() {
      const tref = doc(db, 'tarjetas', tarjetaId);
      const snap = await getDoc(tref);
      if (!snap.exists()) {
        metaEl.textContent = 'Tarjeta no encontrada';
        return;
      }
      const data = snap.data();
      currentTarjeta = data;
      metaEl.innerHTML = `<b>Campo:</b> ${data.campoNombre || 'N/A'} <br/><b>Juego:</b> ${data.juegoId || ''}`;
      renderHoyoInputs(data.scores || []);

    }

    function renderEntries(arr) {
      entriesList.innerHTML = '';
      if (!arr.length) {
        entriesList.innerHTML = '<div class="small">No hay entradas aún.</div>';
        return;
      }
      // mostrar en orden cronológico
      arr.slice().reverse().forEach(e => {
        const d = document.createElement('div');
        d.className = 'entry';
        const left = document.createElement('div');
        left.innerHTML = `<b>Hoyo ${e.hoyo}</b><div class="small">${new Date(e.createdAt?.toMillis ? e.createdAt.toMillis() : (e.createdAt||Date.now())).toLocaleString()}</div>`;
        const right = document.createElement('div');
        right.innerHTML = `<div style="font-weight:800">${e.golpes}</div>`;
        d.appendChild(left); d.appendChild(right);
        entriesList.appendChild(d);
      });
    }

    tarjetaForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    try {
        const scoresArray = [];
        for(let i=1;i<=18;i++){
        const val = parseInt(document.getElementById(`hoyo${i}`).value,10);
        if(!isNaN(val)) scoresArray.push({ hoyo:i, golpes:val, createdAt: serverTimestamp() });
        }
        const tref = doc(db,'tarjetas',tarjetaId);
        await updateDoc(tref, { scores: scoresArray, lastUpdated: serverTimestamp() });
        await cargarTarjeta();
        alert('Tarjeta guardada!');
    } catch(err){
        console.error(err);
        alert('Error guardando tarjeta');
    }
    });


    refrescarBtn.addEventListener('click', cargarTarjeta);

    // cargar al inicio (no espera auth estricto)
    cargarTarjeta();
  </script>
</body>
</html>
