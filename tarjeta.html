<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tarjeta - Golftrix</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet" />
<style>
body { font-family:'Orbitron',sans-serif; margin:0; padding:12px; background: #f6f6f6; color:#111; }
.container {
  max-width:900px;
  margin:0 auto;
}
.form-card { 
  background:white; 
  border-radius:12px; 
  padding:12px; 
  box-shadow:0 6px 18px rgba(0,0,0,0.08); 
  display:flex; 
  flex-direction:column; 
}
h2 { margin:0 0 12px 0; color:#005600; text-align:center; }
/* -> Asegura box-sizing para que paddings no rompan columnas */
* { box-sizing: border-box; }

/* ETIQUETAS (labels) con texto en gradiente verde (ajustadas) */
.hoyo-card label {
  display: block;
  font-weight: 700;
  margin-bottom: 6px;
  font-family: 'Orbitron', sans-serif;
  font-size: 0.88rem; /* un poco más pequeño para ahorrar espacio */
  /* texto con gradiente (fallback color usado si no soporta background-clip) */
  background: linear-gradient(90deg, #007f00, #00cc44);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  -webkit-text-fill-color: transparent;
}

/* INPUTS con borde en gradiente y tipografía Orbitron (más compactos) */
.hoyo-card input[type="number"] {
  width: 100%;
  padding: 6px 8px;           /* menos padding para que quepan en las columnas */
  height: 36px;               /* altura controlada para consistencia */
  border-radius: 8px;
  border: 2px solid transparent;
  margin-bottom: 6px;
  text-align: center;
  font-family: 'Orbitron', sans-serif;
  font-weight: 700;
  font-size: 0.95rem;
  background-image: linear-gradient(white, white), linear-gradient(90deg, #007f00, #00cc44);
  background-origin: padding-box, border-box;
  background-clip: padding-box, border-box;
  outline: none;
  transition: box-shadow .12s ease, transform .06s ease;
  box-sizing: border-box;
  max-width: 100%;
}

/* foco: resaltar con halo sutil */
.hoyo-card input[type="number"]:focus {
  box-shadow: 0 0 0 4px rgba(0,204,68,0.08);
  transform: translateY(-1px);
}

/* Grid de hoyos: usar minmax para evitar overflow */
#hoyosContainer {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px;
  align-items: start;
}
@media (max-width:700px) {
  #hoyosContainer { grid-template-columns: 1fr; }
}

/* cartas de hoyo: menos padding para que quepan en 2 columnas */
.hoyo-card {
  background:#f7f7f7;
  padding:6px;
  border-radius:8px;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  text-align:center;
}

/* Botón guardar */
button.save {
  background: linear-gradient(90deg,#007f00,#00cc44);
  color:#fff;
  border:none;
  padding:10px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:800;
  margin-top:8px;
  font-family:'Orbitron',sans-serif;
}

/* Nota pequeña */
.small { font-size:0.85rem; color:#666; text-align:center; margin-bottom:8px; }

</style>
</head>
<body>
<div class="container">
  <div class="form-card" id="formCard">
  <h2>Tu Tarjeta</h2>
  <div id="meta" class="small">Cargando...</div>

  <form id="tarjetaForm">
    <!-- Nota instructiva antes de los hoyos -->
    <div class="small" style="margin-bottom:10px; text-align:center; font-weight:700;">
      Nota: Debes hacer clic en "Guardar Cambios" para almacenar la información de tu tarjeta.
    </div>

    <!-- Botón extra que dispara el guardado (no es submit para evitar doble envío accidental) -->
    <div style="text-align:center; margin-bottom:8px;">
      <button type="button" id="guardarTop" class="save" style="padding:8px 14px;">Guardar Cambios</button>
    </div>

    <div id="hoyosContainer"></div>

    <!-- submit original (queda como estaba) -->
    <div style="text-align:center; margin-top:10px;">
      <button type="submit" class="save">Guardar Tarjeta</button>
    </div>
  </form>
</div>

</div>

<script>
function getQueryParam(n){ const u=new URL(location.href); return u.searchParams.get(n); }
</script>

<script type="module">
import { app, db } from './firebase-config.js';
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const tarjetaId = getQueryParam('tarjetaId');
const metaEl = document.getElementById('meta');
const hoyosContainer = document.getElementById('hoyosContainer');
const tarjetaForm = document.getElementById('tarjetaForm');
// botón superior que dispara el guardado del formulario
const guardarTopBtn = document.getElementById('guardarTop');
if (guardarTopBtn) {
  guardarTopBtn.addEventListener('click', () => {
    // requestSubmit() usa el handler del formulario; si no existe, fallback a dispatchEvent
    if (typeof tarjetaForm.requestSubmit === 'function') {
      tarjetaForm.requestSubmit();
    } else {
      // fallback para navegadores antiguos
      tarjetaForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
    }
  });
}


if (!tarjetaId) {
  metaEl.textContent = 'Falta tarjetaId en la URL';
  throw new Error('Falta tarjetaId');
}

const authInst = getAuth(app);
let currentTarjeta = null;

// Render de los hoyos
function renderHoyoInputs(scores, completada = false) {
  hoyosContainer.innerHTML = '';
  for (let i = 1; i <= 18; i++) {
    const golpes = scores?.find(s => s.hoyo === i)?.golpes || '';
    const div = document.createElement('div');
    div.className = 'hoyo-card';
    div.innerHTML = `
      <label for="hoyo${i}">Hoyo ${i}</label>
      <input type="number" id="hoyo${i}" min="0" value="${golpes}" ${completada ? 'readonly' : ''} />
    `;
    hoyosContainer.appendChild(div);
  }
  
  // Si está completada, deshabilitar botones de guardado
  if (completada) {
    const botonesGuardar = document.querySelectorAll('button.save, #guardarTop');
    botonesGuardar.forEach(boton => {
      boton.disabled = true;
      boton.style.opacity = '0.5';
      boton.style.cursor = 'not-allowed';
    });
  }
}

// Verificar si todos los 18 hoyos tienen valores numéricos
function verificarCompletitudTarjeta() {
  let todosCompletados = true;
  let hoyosCompletados = 0;
  
  for (let i = 1; i <= 18; i++) {
    const input = document.getElementById(`hoyo${i}`);
    if (input) {
      const valor = input.value.trim();
      if (valor !== '' && !isNaN(parseInt(valor, 10))) {
        hoyosCompletados++;
      } else {
        todosCompletados = false;
      }
    }
  }
  
  return { todosCompletados, hoyosCompletados };
}

// Cargar tarjeta desde Firestore
async function cargarTarjeta() {
  try {
    const tref = doc(db, 'tarjetas', tarjetaId);
    const snap = await getDoc(tref);
    if (!snap.exists()) {
      metaEl.textContent = 'Tarjeta no encontrada';
      return;
    }
    const data = snap.data();
    currentTarjeta = data;
    
    // Asegurar que la tarjeta tenga los campos necesarios para handicap.js
    if (!currentTarjeta.ownerUid) {
      // Intentar obtener el UID del usuario actual
      const user = authInst.currentUser;
      if (user) {
        currentTarjeta.ownerUid = user.uid;
      }
    }
    
    // Mostrar estado de completitud en el meta
    const estadoCompletada = data.completada ? " (COMPLETADA - Solo lectura)" : " (En edición)";
    metaEl.textContent = `Campo: ${data.campoNombre || 'N/A'} | Juego: ${data.juegoId || ''}${estadoCompletada}`;
    
    renderHoyoInputs(data.scores || [], data.completada);
  } catch(err) {
    console.error('Error cargando tarjeta', err);
    metaEl.textContent = 'Error cargando tarjeta';
  }
}

// Guardar la tarjeta (uno o varios hoyos) — REEMPLAZAR todo el bloque actual
tarjetaForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // Verificar si la tarjeta ya está completada (no permitir editar)
  if (currentTarjeta?.completada) {
    alert('Esta tarjeta ya está completada y no se puede editar.');
    return;
  }
  
  // Verificar completitud de todos los hoyos
  const { todosCompletados, hoyosCompletados } = verificarCompletitudTarjeta();
  
  // Si faltan hoyos por completar, proceder con guardado normal
  if (!todosCompletados) {
    // Guardado normal (sin confirmación especial)
    await guardarTarjeta(false); // false = no está completando todos los hoyos
    return;
  }
  
  // Si TODOS los hoyos están completos, mostrar confirmación
  const confirmar = confirm(`⚠️ ADVERTENCIA\n\nHas completado los 18 hoyos (${hoyosCompletados}/18).\n\n¿Estás seguro de guardar la tarjeta?\n\nUna vez guardada, NO podrás editarla nuevamente.\n\n¿Continuar con el guardado definitivo?`);
  
  if (!confirmar) {
    return; // El usuario canceló
  }
  
  // Guardar como completada
  await guardarTarjeta(true);
});

// Función auxiliar para guardar la tarjeta
async function guardarTarjeta(completarTarjeta = false) {
  try {
    // Clonamos las scores actuales como base (si existen)
    let updatedScores = currentTarjeta?.scores ? [...currentTarjeta.scores] : [];

    // Marcador temporal cliente para entradas nuevas/actualizadas
    const nowMillis = Date.now();

    for (let i = 1; i <= 18; i++) {
      const input = document.getElementById(`hoyo${i}`);
      // si el input no existe lo saltamos (defensivo)
      if (!input) continue;
      const val = parseInt(input.value, 10);
      if (!isNaN(val)) {
        const idx = updatedScores.findIndex(s => s.hoyo === i);
        if (idx >= 0) {
          // Actualiza el registro existente (no usamos serverTimestamp dentro del array)
          updatedScores[idx] = {
            ...updatedScores[idx],
            golpes: val,
            updatedAtMillis: nowMillis
          };
        } else {
          // Agrega nueva entrada con marca de tiempo cliente (millis)
          updatedScores.push({
            hoyo: i,
            golpes: val,
            createdAtMillis: nowMillis
          });
        }
      }
    }

    // Preparar datos para actualizar
    const updateData = {
      scores: updatedScores,
      lastUpdated: serverTimestamp()
    };
    
    // Si estamos completando la tarjeta, agregar campo completada
    if (completarTarjeta) {
      updateData.completada = true;
      updateData.fechaCompletada = serverTimestamp();
      
      // Asegurar que la tarjeta tenga ownerUid para que handicap.js funcione
      if (!currentTarjeta?.ownerUid) {
        const user = authInst.currentUser;
        if (user) {
          updateData.ownerUid = user.uid;
        }
      }
      
      // Asegurar que la tarjeta tenga createdAt si no existe
      if (!currentTarjeta?.createdAt) {
        updateData.createdAt = serverTimestamp();
      }
      
      // NOTA: NO actualizamos handicap, handicapSigned, lastHandicapUpdated aquí
      // porque esos campos son históricos y se guardaron al crear la tarjeta
      // handicap.js se encargará de actualizar el handicap del USUARIO (no de la tarjeta)
    }

    // Guardar en Firestore
    const tref = doc(db, 'tarjetas', tarjetaId);
    await updateDoc(tref, updateData);

    // Si se completó la tarjeta, ejecutar handicap.js
    if (completarTarjeta) {
      try {
        // Importar y ejecutar handicap.js con la función correcta
        const { calculateAndSaveHandicap } = await import('./handicap.js');
        if (typeof calculateAndSaveHandicap === 'function') {
          // Obtener el UID del usuario actual para pasarle a la función
          const user = authInst.currentUser;
          if (user) {
            await calculateAndSaveHandicap(user.uid);
          } else {
            console.log('Usuario no autenticado al intentar calcular handicap');
          }
        } else {
          console.log('Función calculateAndSaveHandicap no encontrada en handicap.js');
        }
      } catch (error) {
        console.error('Error ejecutando handicap.js:', error);
        // Continuar aunque falle el handicap, la tarjeta ya se guardó
      }
    }

    // Recargar la tarjeta desde Firestore para reflejar datos actualizados
    await cargarTarjeta();
    
    // Mostrar mensaje apropiado
    if (completarTarjeta) {
      alert('✅ Tarjeta guardada y COMPLETADA exitosamente!\n\nLa tarjeta ahora es de solo lectura y no se puede editar.\n\nSe ha ejecutado el cálculo de handicap para actualizar tu handicap actual.');
    } else {
      alert('Tarjeta guardada correctamente!');
    }
  } catch (err) {
    console.error('Error guardando tarjeta', err);
    alert('Error guardando tarjeta');
  }
}


// Inicia cargando
onAuthStateChanged(authInst, async (user) => {
  if (!user) {
    metaEl.textContent = 'Debes iniciar sesión';
    return;
  }
  await cargarTarjeta();
});
</script>
</body>
</html>
