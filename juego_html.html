<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Juego - Golftrix</title>
  <link rel="icon" href="logo_golftrix.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="menu.css" />

  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Orbitron', sans-serif; margin:0; min-height:100vh; display:flex; flex-direction:column; }
    header { background: linear-gradient(90deg,#007f00,#00cc44); color:white; display:flex; align-items:center; justify-content:space-between; padding:12px 20px; }
    header h1 { margin:0; font-size:1.6rem; text-align:center; flex:1; }
    main { flex:1; padding:20px; max-width:1200px; margin:0 auto; width:100%; display:flex; flex-direction:column; gap:16px; }

    .top-row { display:flex; gap:16px; align-items:flex-start; width:100%; }
    /* left column is iframe tarjeta, right column is resumen del juego */
    .left { flex:1; min-width:280px; }
    .right { width:360px; max-width:40%; min-width:220px; display:flex; flex-direction:column; gap:12px; }

    .card { background: rgba(255,255,255,0.95); padding:12px; border-radius:14px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .game-title { font-size:1.25rem; font-weight:700; color:#004d00; }

    iframe.tarjeta-frame { width:100%; height:520px; border-radius:12px; border:0; box-shadow:0 4px 12px rgba(0,0,0,0.15); }

    .modos-grid { display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }
    .modo-btn { background: linear-gradient(90deg,#007f00,#00cc44); color:white; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; font-family:'Orbitron'; }
    .modo-btn:hover{ transform:translateY(-2px); }

    .meta-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; color:#333; font-size:0.95rem; }
    .meta { background: rgba(0,0,0,0.06); padding:6px 8px; border-radius:8px; }

    .small-note { color:#666; font-size:0.9rem; }

    /* botones de tarjeta y modos en fila en PC */
        .botones-acciones {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
        }

        /* en móvil se muestran en columna centrada */
        @media(max-width: 900px) {
        .botones-acciones {
            flex-direction: column;
            align-items: center;
        }
        .top-row { flex-direction:column; }
        .right { width:100%; max-width:none; }
        iframe.tarjeta-frame { height:420px; }
        header {
          flex-direction: column;
          justify-content: center;
          text-align: center;
        }
        header h1 {
          font-size: 1.3rem;
          margin-top: 6px;
        }
        header img {
          height: 60px !important;
          margin: 0 auto;
        }
        .top-row {
          flex-direction: column-reverse; /* primero right, luego left */
        }
        .meta-row {
          justify-content: center;
          text-align: center;
        }
        .meta {
          font-size: 0.8rem;
        }
        #ownerNote {
          text-align: center;
        }
        .modos-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
          gap: 8px;
          justify-items: center;
        }
        .left, .right {
          width: 100% !important;
          max-width: 100% !important;
          margin: 0 auto;
        }
        main {
          padding: 10px;
        }
        body {
          zoom: 0.9;
        }

      }


    
  </style>
</head>
<body>
  <header>
    <div id="menuContainer"></div>
    <h1>Juego — Golftrix</h1>
    <a href="dashboard.html" title="Ir al Dashboard" aria-label="Ir al Dashboard">
      <img src="logo_golftrix.png" alt="logo" id="logo" style="height:80px; cursor:pointer;" />
    </a>

  </header>

  <main>
    <div class="top-row">
      <div class="left card" id="leftArea">
        <!-- Aquí se inyecta la tarjeta o los modos -->
        <div style="text-align:center;color:#666;">Selecciona Tarjeta o un Modo para empezar.</div>
        </div>


      <div class="right card" id="rightArea">
        <div id="gameInfo">
          <div class="game-title" id="campoNombre">Cargando...</div>
          <div class="meta-row">
            <div class="meta" id="tipoBadge"></div>
            <div class="meta" id="fechaBadge"></div>
          </div>
          <div class="small-note" id="ownerNote" style="margin-top:8px;"></div>

          <div style="margin-top:12px;">
            <div style="font-weight:700;margin-bottom:6px;">Modos disponibles</div>
            <div class="modos-grid" id="modosContainer"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">Instrucciones rápidas</div>
      <div class="small-note">
        1) En la tarjeta (a la izquierda) llena los hoyos y guarda. <br/>
        2) Usa los botones de Modo para abrir el modo elegido (se abrirá en nueva pestaña con contexto del juego).<br/>
        3) Si necesitas cargar la tarjeta en otra pantalla, copia el link (se generó una tarjeta personal para ti).
      </div>
    </div> -->
  </main>

  <footer style="background:#000;color:#fff;padding:10px;text-align:center;">&copy; 2025 Golftrix</footer>

  <script>
    // helper para leer query param
    function getQueryParam(n){ const u=new URL(location.href); return u.searchParams.get(n); }
  </script>

  <script type="module">
    import { app, db, auth } from './firebase-config.js';
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import {
    doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp, updateDoc, arrayUnion, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


    const juegoId = getQueryParam('id') || getQueryParam('juegoId');
    const leftArea = document.getElementById('leftArea');
    const modosContainer = document.getElementById('modosContainer');
    const campoNombreEl = document.getElementById('campoNombre');
    const tipoBadge = document.getElementById('tipoBadge');
    const fechaBadge = document.getElementById('fechaBadge');
    const ownerNote = document.getElementById('ownerNote');

    if (!juegoId) {
      leftArea.innerHTML = '<div style="color:#b33;">Falta el parámetro id en la URL</div>';
      throw new Error('Falta id en URL');
    }

    const authInst = getAuth(app);

    onAuthStateChanged(authInst, async (user) => {
      if (!user) {
        // si no está logueado redirigir
        window.location.href = 'index.html';
        return;
      }
      try {
        // 1) traer documento juego
        const jref = doc(db, 'juegos', juegoId);
        const jsnap = await getDoc(jref);
        if (!jsnap.exists()) {
          leftArea.innerHTML = '<div style="color:#b33;">Juego no encontrado</div>';
          return;
        }
        const juego = jsnap.data();

        // llenar info del panel derecho
        campoNombreEl.textContent = juego.campoNombre || 'Juego sin nombre';
        tipoBadge.textContent = (juego.tipo || '').toUpperCase();
        fechaBadge.textContent = juego.createdAt?.toDate ? juego.createdAt.toDate().toLocaleDateString('es-MX', { day:'2-digit', month:'short', year:'2-digit' }) : '';
        // Mostrar nombre del creador usando su documento en "users" (fallback al UID)
        let ownerLabel = juego.ownerUid || 'desconocido';
        if (juego.ownerUid) {
          try {
            const uref = doc(db, 'users', juego.ownerUid);
            const usnap = await getDoc(uref);
            if (usnap.exists()) {
              const udata = usnap.data();
              // Intentar varios nombres de campo comunes
              const first = udata.name ?? udata.nombre ?? udata.firstName ?? udata.firstname ?? '';
              const last  = udata.lastName ?? udata.apellido ?? udata.lastname ?? udata.lastame ?? udata.apellidoPaterno ?? '';
              const fullName = [first, last].filter(Boolean).join(' ').trim();
              if (fullName) ownerLabel = fullName;
            }
          } catch (e) {
            console.error('Error cargando usuario creador:', e);
            // fallback: dejar ownerLabel como el UID
          }
        }
        ownerNote.textContent = `Creado por: ${ownerLabel}`;


        // 2) buscar o crear tarjeta del usuario para este juego
        const uid = user.uid;
        // query tarjetas where juegoId == juegoId and userUid == uid
        const tarjetasCol = collection(db, 'tarjetas');
        const q = query(tarjetasCol, where('juegoId','==', juegoId), where('userUid','==', uid));
        const snap = await getDocs(q);
        let tarjetaDocId = null;
        if (snap.size > 0) {
          tarjetaDocId = snap.docs[0].id;
        } else {
          // crear tarjeta
          const newTarjeta = {
            juegoId,
            campoId: juego.campoId || null,
            campoNombre: juego.campoNombre || null,
            userUid: uid,
            ownerUid: juego.ownerUid || null,
            createdAt: serverTimestamp(),
            estado: 'activa',
            scores: [] // array de objetos { hoyo: number, golpes: number, createdAt: Timestamp }
          };
          const added = await addDoc(tarjetasCol, newTarjeta);
          tarjetaDocId = added.id;
        }

       // 3) generar botón de tarjeta y botones de modos
        modosContainer.innerHTML = '';
        const accionesDiv = document.createElement('div');
        accionesDiv.className = 'botones-acciones';

        // botón Tarjeta
        const tarjetaBtn = document.createElement('button');
        tarjetaBtn.className = 'modo-btn';
        tarjetaBtn.textContent = 'Tarjeta';
        tarjetaBtn.addEventListener('click', () => {
        leftArea.innerHTML = `<iframe class="tarjeta-frame" src="tarjeta.html?tarjetaId=${tarjetaDocId}&juegoId=${juegoId}" loading="lazy"></iframe>`;
        });
        accionesDiv.appendChild(tarjetaBtn);

        // botones de modos (REEMPLAZADO: abrimos el modo en iframe para que sus scripts se ejecuten y reciba juegoId)
        const modos = Array.isArray(juego.modos) ? juego.modos : [];
        if (modos.length === 0) {
          const noModes = document.createElement('div');
          noModes.style.color = '#666';
          noModes.textContent = 'No hay modos configurados en este juego.';
          accionesDiv.appendChild(noModes);
        } else {
          modos.forEach(m => {
              const label = m.replace(/^juego_/,'').replace(/_(grupo|individual)\.html$/,'').replace(/_/g,' ');
              const btn = document.createElement('button');
              btn.className = 'modo-btn';
              btn.textContent = label;
              btn.addEventListener('click', () => {
                // abrimos el modo en un iframe y le pasamos el juegoId en la URL
                leftArea.innerHTML = `<iframe class="tarjeta-frame" src="${m}?juegoId=${encodeURIComponent(juegoId)}" loading="lazy"></iframe>`;
              });
              accionesDiv.appendChild(btn);
          });
        }


        modosContainer.appendChild(accionesDiv);


      } catch (err) {
        console.error('Error en juego_html:', err);
        leftArea.innerHTML = `<div style="color:#b00;">Error cargando juego. Revisa consola.</div>`;
      }
    });
  </script>

  <!-- carga el menu.html y menu.js (igual a otras páginas) -->
  <script>
    fetch('menu.html')
      .then(res => res.text())
      .then(html => {
        const temp = document.createElement('div');
        temp.innerHTML = html;
        const hamburgerBtn = temp.querySelector('.hamburger') || temp.querySelector('#hamburger');
        const sidebarMenu = temp.querySelector('.sidebar-mobile') || temp.querySelector('#sidebarMenu');
        if (hamburgerBtn) document.getElementById('menuContainer').appendChild(hamburgerBtn);
        if (sidebarMenu) document.body.appendChild(sidebarMenu);
        import('./menu.js').catch(e=>console.error(e));
      }).catch(e=>console.error('menu.html:',e));
  </script>
</body>
</html>
