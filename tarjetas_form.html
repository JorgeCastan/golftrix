<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Completar Tarjetas - Golftrix</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet" />
<style>
/* Reutiliza estilos similares a tarjeta.html */
/* Body sin padding para evitar espacio superior y laterales en header */
body { font-family:'Orbitron',sans-serif; margin:0; padding:0; background: #f6f6f6; color:#111; }

/* Contenedor principal con padding interno */
.container { max-width:1000px; margin:0 auto; padding:12px; }

/* Modal */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.45);
  display:flex; align-items:center; justify-content:center; z-index:1000;
}
.modal {
  width: 100%; max-width: 980px; background:white; border-radius:12px; padding:14px;
  box-shadow:0 8px 28px rgba(0,0,0,0.25); max-height:90vh; overflow:auto;
}
h2 { margin:0 0 10px 0; color:#005600; text-align:center; }

/* grid principal */
.top-row { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; }
.badge { background:#eaf9ea; color:#006400; padding:6px 10px; border-radius:10px; font-weight:800; }

/* botones de seleccion de numero de tarjetas */
.select-count { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px; }
.count-btn { padding:8px 12px; border-radius:8px; border:2px solid transparent; background:linear-gradient(90deg,#f0f0f0,#fff); cursor:pointer; font-weight:800; }

/* campo select */
.field { margin-bottom:10px; }
.select { width:100%; padding:8px; border-radius:8px; height:40px; }

/* Tarjetas area */
.cards-list { display:flex; flex-direction:column; gap:12px; }

/* Cada tarjeta a crear */
.card { background:#fafafa; padding:10px; border-radius:10px; }

/* Hoyos grid: 2 columnas desktop, 1 en móvil */
.hoyos-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; }
@media (max-width:700px) {
  .hoyos-grid { grid-template-columns: 1fr; }
}
.hoyo-card { background:#fff; padding:6px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.04); text-align:center; }
.hoyo-card label { display:block; font-weight:700; margin-bottom:4px; font-size:0.85rem; }
.hoyo-card input { width:100%; padding:6px; height:36px; border-radius:6px; text-align:center; }

/* botones */
.btn { padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800; border:none; }
.save { background: linear-gradient(90deg,#007f00,#00cc44); color:#fff; }
.cancel { background:#eee; color:#222; }

/* small note */
.small { font-size:0.88rem; color:#666; }

/* --- Header / menu (copiado de tu tarjeta de referencia) --- */
header {
  background: linear-gradient(90deg, #007f00, #00cc44);
  display: flex;
  align-items: center;
  justify-content: center; /* título centrado */
  position: relative;
  padding: 14px 20px;
  color: white;
  height: 80px;
}

header h1 {
  font-size: 1.6rem;
  margin: 0;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
}

header img#logo {
  height: 72px;
  position: absolute;
  right: 18px;
  cursor: pointer;
}

/* contenedor donde se insertará el botón hamburguesa */
#menuContainer { display:inline-block; margin-left:10px; position: absolute; left: 18px; }

/* Responsive: en móvil colocar logo y título en columna */
@media (max-width:768px) {
  header {
    flex-direction: column;
    height: auto;
    padding: 10px;
    position: static;
  }
  header img#logo {
    position: static;
    height: 48px;
    order: 1;
    margin-bottom: 8px;
  }
  header h1 {
    position: static;
    transform: none;
    font-size: 1.25rem;
    order: 2;
  }
}


</style>
</head>
<body>

<header>
  <!-- aquí se insertará el botón hamburguesa (viene de menu.html) -->
  <div id="menuContainer"></div>

  <h1>Completar Tarjetas</h1>

  <!-- Logo: clic va al dashboard -->
  <img src="logo_golftrix.png" alt="Logo" id="logo" />
</header>


<div class="container">
  <div style="text-align:center; margin-bottom:8px;">
    <button id="openModal" class="btn save">Completar tarjetas faltantes / Calcular Handicap</button>
  </div>
</div>

<!-- Modal (hidden initially) -->
<div id="modalRoot" style="display:none;" class="modal-overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="top-row">
      <h2>Completar Tarjetas para Handicap</h2>
      <div><button id="closeModal" class="btn cancel">Cerrar</button></div>
    </div>

    <div id="statusLine" class="small">Consultando tarjetas...</div>

    <div style="margin-top:8px;">
      <div id="missingBadge" class="badge" style="display:none;"></div>
      <div class="small" style="margin:6px 0;">Selecciona la cantidad de tarjetas a llenar:</div>
      <div id="countButtons" class="select-count"></div>
    </div>

    <div style="margin-top:10px;">
      <label class="small">Selecciona campo</label>
      <select id="campoSelect" class="select"></select>
    </div>

    <div id="cardsContainer" class="cards-list"></div>

    <div style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
      <button id="saveCardsBtn" class="btn save">Guardar tarjetas y calcular handicap</button>
      <button id="cancelBtn" class="btn cancel">Cancelar</button>
    </div>

    <div id="resultMsg" style="margin-top:12px;" class="small"></div>
  </div>
</div>

<script>
function getQueryParam(n){ const u=new URL(location.href); return u.searchParams.get(n); }
</script>

<script type="module">
import { app, db } from './firebase-config.js';
import { calculateAndSaveHandicap } from './handicap.js'; // importa el módulo anterior
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection,
  query,
  where,
  orderBy,
  getDocs,
  addDoc,
  serverTimestamp,
  doc,
  setDoc,
  getDoc,
  limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const auth = getAuth(app);

// DOM
const openModalBtn = document.getElementById('openModal');
const modalRoot = document.getElementById('modalRoot');
const closeModalBtn = document.getElementById('closeModal');
const countButtons = document.getElementById('countButtons');
const campoSelect = document.getElementById('campoSelect');
const cardsContainer = document.getElementById('cardsContainer');
const saveCardsBtn = document.getElementById('saveCardsBtn');
const cancelBtn = document.getElementById('cancelBtn');
const missingBadge = document.getElementById('missingBadge');
const statusLine = document.getElementById('statusLine');
const resultMsg = document.getElementById('resultMsg');

let currentUserUid = null;
let availableCardsCount = 0;
let missingCount = 0;
let selectedCount = 0;
let campos = []; // lista de camposGolf
// estructura para mantener datos de input sin perderlos al cambiar cantidad
// será un array con length = maxNeeded (10) => each element tiene {fecha, campoId, scores: {1:val,...,18:val}}
const tempEntries = [];

function openModal() {
  modalRoot.style.display = 'flex';
}
function closeModal() {
  modalRoot.style.display = 'none';
}

// cargar campos de golf
async function loadCampos() {
  campoSelect.innerHTML = '<option value="">Cargando campos...</option>';
  const q = query(collection(db, 'camposGolf'), orderBy('nombre'));
  const snap = await getDocs(q);
  campos = [];
  snap.forEach(s => {
    const d = s.data();
    campos.push({ id: s.id, nombre: d.nombre });
  });
  campoSelect.innerHTML = '<option value="">-- Selecciona campo --</option>';
  campos.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.nombre;
    campoSelect.appendChild(opt);
  });
}

// calcula cuántas tarjetas completas tiene el usuario
async function countUserCompleteCards(uid) {
  // traemos tarjetas ownerUid==uid y filtramos por 18 hoyos completos
  // para eficiencia limitamos a 50
  const q = query(collection(db, 'tarjetas'), where('ownerUid', '==', uid), orderBy('createdAtMillis', 'desc'), limit(50));
  const snap = await getDocs(q);
  let count = 0;
  snap.forEach(snapDoc => {
    const d = snapDoc.data();
    if (d?.scores && Array.isArray(d.scores) && d.scores.length >= 18) {
      // chequeo simple: que existan hoyos 1..18
      const set = new Set(d.scores.map(x => x.hoyo));
      let ok = true;
      for (let i = 1; i <= 18; i++) { if (!set.has(i)) { ok = false; break; } }
      if (ok) count++;
    }
  });
  return count;
}

// genera botones de tarjeta 1..N
function renderCountButtons(maxMissing) {
  countButtons.innerHTML = '';
  for (let i = 1; i <= maxMissing; i++) {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'count-btn';
    btn.textContent = `Tarjeta ${i}`;
    btn.dataset.index = i;
    btn.addEventListener('click', () => {
      selectedCount = i;
      renderCardInputs();
      // marcar seleccion
      Array.from(countButtons.children).forEach(ch => ch.style.boxShadow = '');
      btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)';
    });
    countButtons.appendChild(btn);
  }
  // seleccionar por defecto 1
  if (maxMissing > 0) {
    selectedCount = 1;
    countButtons.firstChild.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)';
  } else {
    selectedCount = 0;
  }
}

// render de inputs para N tarjetas (no borra datos previos)
function renderCardInputs() {
  cardsContainer.innerHTML = '';
  for (let t = 0; t < selectedCount; t++) {
    if (!tempEntries[t]) {
      // inicializar con estructura vacia
      tempEntries[t] = { fecha: '', campoId: '', scores: {} };
    }
    const entry = tempEntries[t];

    const cardDiv = document.createElement('div');
    cardDiv.className = 'card';
    cardDiv.innerHTML = `
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
        <strong>Tarjeta ${t+1}</strong>
        <div class="small">Fecha: <input type="date" data-t="${t}" data-field="fecha" /></div>
      </div>
      <div style="margin-top:8px;">
        <label class="small">Campo (opcional, si lo seleccionas se guardará en la tarjeta)</label>
        <select data-t="${t}" data-field="campoId" class="select"></select>
      </div>
      <div style="margin-top:8px;">
        <div class="hoyos-grid" id="grid-${t}"></div>
      </div>
    `;
    cardsContainer.appendChild(cardDiv);

    // fecha input
    const fechaInput = cardDiv.querySelector('input[type="date"]');
    fechaInput.value = entry.fecha || '';
    fechaInput.addEventListener('change', (e) => {
      tempEntries[t].fecha = e.target.value;
    });

    // campo select
    const sel = cardDiv.querySelector('select[data-field="campoId"]');
    sel.innerHTML = '<option value="">-- Selecciona campo --</option>';
    campos.forEach(c => {
      const o = document.createElement('option');
      o.value = c.id;
      o.textContent = c.nombre;
      if (entry.campoId === c.id) o.selected = true;
      sel.appendChild(o);
    });
    sel.addEventListener('change', (e) => {
      tempEntries[t].campoId = e.target.value;
    });

    // hoyos grid
    const grid = cardDiv.querySelector(`#grid-${t}`);
    grid.innerHTML = '';
    for (let i = 1; i <= 18; i++) {
      const val = entry.scores && typeof entry.scores[i] !== 'undefined' ? entry.scores[i] : '';
      const div = document.createElement('div');
      div.className = 'hoyo-card';
      div.innerHTML = `
        <label>Hoyo ${i}</label>
        <input type="number" min="0" data-t="${t}" data-hoyo="${i}" value="${val}" />
      `;
      grid.appendChild(div);
      const inp = div.querySelector('input');
      inp.addEventListener('input', (e) => {
        const v = e.target.value;
        tempEntries[t].scores[i] = v === '' ? undefined : Number(v);
      });
    }
  }
}

// guardar tarjetas creadas por el usuario en firestore
async function saveNewCardsAndRecalc(uid) {
  if (selectedCount <= 0) {
    resultMsg.textContent = 'Selecciona al menos una tarjeta.';
    return;
  }
  // validaciones: cada tarjeta debe tener fecha y 18 hoyos completos (no vacíos)
  for (let t = 0; t < selectedCount; t++) {
    const e = tempEntries[t];
    // comprobar 18 hoyos presentes
    let ok = true;
    for (let i = 1; i <= 18; i++) {
      if (typeof e.scores[i] !== 'number' || Number.isNaN(e.scores[i])) { ok = false; break; }
    }
    if (!ok) {
      resultMsg.textContent = `La tarjeta ${t+1} no tiene los 18 hoyos completos.`;
      return;
    }
  }

  resultMsg.textContent = 'Guardando tarjetas...';
  // crear cada documento en collection 'tarjetas'
  const col = collection(db, 'tarjetas');
  try {
    for (let t = 0; t < selectedCount; t++) {
      const e = tempEntries[t];
      // construir array scores como en el ejemplo original
      const scoresArray = [];
      const nowMillis = Date.now();
      for (let i = 1; i <= 18; i++) {
        scoresArray.push({
          hoyo: i,
          golpes: Number(e.scores[i]),
          createdAtMillis: nowMillis
        });
      }

      const docPayload = {
        campoId: e.campoId || '',
        campoNombre: (campos.find(c=>c.id===e.campoId)?.nombre) || '',
        createdAt: e.fecha ? new Date(e.fecha) : serverTimestamp(),
        createdAtMillis: e.fecha ? new Date(e.fecha).getTime() : Date.now(),
        estado: 'activa',
        ownerUid: uid,
        userUid: uid,
        scores: scoresArray,
        lastUpdated: serverTimestamp()
      };

      await addDoc(col, docPayload);
    }

    resultMsg.textContent = 'Tarjetas guardadas. Calculando handicap...';

    // recalcular y guardar handicap
    const res = await calculateAndSaveHandicap(uid);
    if (res.ok && res.saved) {
      resultMsg.textContent = `Handicap calculado y guardado: ${res.handicap}`;
    } else if (res.ok && !res.saved) {
      resultMsg.textContent = `Handicap calculado: ${res.handicap} (no se pudo guardar automáticamente).`;
    } else {
      if (res.missing) {
        resultMsg.textContent = `Aún faltan ${res.missing} tarjetas para calcular handicap.`;
      } else {
        resultMsg.textContent = `Error: ${res.message || 'No se pudo calcular el handicap.'}`;
      }
    }

    // cerrar modal despues de exito (opcional): lo dejamos visible para feedback
  } catch (err) {
    console.error('Error guardando tarjetas:', err);
    resultMsg.textContent = 'Error guardando tarjetas. Revisa la consola.';
  }
}

// flujo inicial: contar tarjetas y mostrar missing
async function prepareModalForUser(uid) {
  statusLine.textContent = 'Consultando tarjetas y campos...';
  await loadCampos();
  const count = await countUserCompleteCards(uid);
  availableCardsCount = count;
  missingCount = Math.max(0, 10 - availableCardsCount);
  missingBadge.style.display = missingCount > 0 ? 'inline-block' : 'none';
  missingBadge.textContent = missingCount > 0 ? `Te hacen falta ${missingCount} tarjetas` : 'Tienes 10 o más tarjetas';
  statusLine.textContent = `Tarjetas completas encontradas: ${availableCardsCount}`;

  // preparar botones (max que puede llenar a la vez = missingCount)
  // si missingCount == 0, el modal puede servir para forzar recalculo: ofrecer 0..10?
  const maxMissing = missingCount > 0 ? missingCount : 0;
  renderCountButtons(maxMissing);

  // inicializar tempEntries vacías hasta maxMissing
  for (let i = 0; i < maxMissing; i++) {
    if (!tempEntries[i]) tempEntries[i] = { fecha: '', campoId: '', scores: {} };
  }
  // limpiar container
  cardsContainer.innerHTML = '';
  resultMsg.textContent = '';
}

// Eventos
openModalBtn.addEventListener('click', async () => {
  const user = auth.currentUser;
  if (!user) {
    // esperar a autenticación
    statusLine.textContent = 'Espera: debes iniciar sesión.';
    openModal(); // abrir para mostrar mensaje de login
    return;
  }
  currentUserUid = user.uid;
  await prepareModalForUser(currentUserUid);
  openModal();
});

closeModalBtn.addEventListener('click', closeModal);
cancelBtn.addEventListener('click', closeModal);

// Guardar tarjetas
saveCardsBtn.addEventListener('click', async () => {
  if (!currentUserUid) {
    resultMsg.textContent = 'No hay usuario autenticado.';
    return;
  }
  await saveNewCardsAndRecalc(currentUserUid);
});

// Si el usuario no estaba autenticado al presionar abrir, actualizamos al hacer login
onAuthStateChanged(auth, async (u) => {
  if (u) {
    currentUserUid = u.uid;
    // opcional: auto-prepare si modal abierto
  } else {
    currentUserUid = null;
  }
});
</script>

<!-- CONTENEDOR DONDE SE INYECTARÁ EL MENÚ -->
<div id="menuContainer"></div>

<!-- Cargar menú -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  fetch("menu.html")
    .then(r => r.text())
    .then(html => {
      document.getElementById("menuContainer").innerHTML = html;

      // Necesario porque el menú usa funciones JS
      const script = document.createElement("script");
      script.src = "menu.js";
      script.onload = () => {
        if (typeof initMenu === "function") {
          initMenu(); // inicializa el menú
        } else {
          console.error("⚠️ initMenu() no existe en menu.js");
        }
      };
      document.body.appendChild(script);
    })
    .catch(err => console.error("Error cargando el menú:", err));
});
</script>


<script>
  // LOGO → Dashboard
  const logo = document.getElementById("logo");
  if (logo) {
    logo.addEventListener("click", () => {
      window.location.href = "dashboard.html";
    });
  }
</script>



</body>
</html>
