<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Completar Tarjetas - Golftrix</title>
<link rel="icon" href="logo_golftrix.png" type="image/png" />
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="menu.css" />
<style>
/* Reutiliza estilos similares a tarjeta.html */
body { 
  font-family:'Orbitron',sans-serif; 
  margin:0; 
  padding:0;  /* CAMBIADO: quitar padding general */
  background: #f6f6f6; 
  color:#111;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* NUEVO: HEADER ESTILO GOLFTRIX */
  header {
      background: linear-gradient(90deg, #007f00, #00cc44);
      display: flex;
      align-items: center;
      justify-content: center; /* Para centrar el título horizontalmente */
      position: relative;
      padding: 20px 40px;
      color: white;
      height: 80px; /* para dar altura fija */
    }

    /* Título centrado absoluto */
    header h1 {
      font-size: 2rem;
      margin: 0;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    /* Logo a la derecha, grande */
    header img {
      height: 100px;
      position: absolute;
      right: 20px;
      cursor: pointer;
    }

/* Ajustes para móvil */
@media (max-width: 768px) {
  header {
    flex-direction: column;
    height: auto;
    padding: 20px;
    position: static;
  }

  header img {
    position: static;
    height: 60px;
    order: 1;
    margin-bottom: 10px;
  }

  header h1 {
    position: static;
    order: 2;
    transform: none;
    font-size: 1.8rem;
  }
}

.container { 
  max-width:1000px; 
  margin:0 auto; 
  padding: 20px 12px; /* AGREGAR padding aquí en vez de en body */
  flex: 1;
}

/* Modal */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.45);
  display:flex; align-items:center; justify-content:center; z-index:1000;
}
.modal {
  width: 100%; max-width: 980px; background:white; border-radius:12px; padding:14px;
  box-shadow:0 8px 28px rgba(0,0,0,0.25); max-height:90vh; overflow:auto;
}
h2 { margin:0 0 10px 0; color:#005600; text-align:center; }

/* grid principal */
.top-row { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; }
.badge { background:#eaf9ea; color:#006400; padding:6px 10px; border-radius:10px; font-weight:800; }

/* botones de seleccion de numero de tarjetas */
.select-count { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px; }
.count-btn { padding:8px 12px; border-radius:8px; border:2px solid transparent; background:linear-gradient(90deg,#f0f0f0,#fff); cursor:pointer; font-weight:800; }

/* campo select */
.field { margin-bottom:10px; }
.select { width:100%; padding:8px; border-radius:8px; height:40px; }

/* Tarjetas area */
.cards-list { display:flex; flex-direction:column; gap:12px; }

/* Cada tarjeta a crear */
.card { background:#fafafa; padding:10px; border-radius:10px; }

/* Hoyos grid: 2 columnas desktop, 1 en móvil */
.hoyos-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; }
@media (max-width:700px) {
  .hoyos-grid { grid-template-columns: 1fr; }
}
.hoyo-card { background:#fff; padding:6px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.04); text-align:center; }
.hoyo-card label { display:block; font-weight:700; margin-bottom:4px; font-size:0.85rem; }
.hoyo-card input { width:100%; padding:6px; height:36px; border-radius:6px; text-align:center; }

/* botones */
.btn { padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800; border:none; }
.save { background: linear-gradient(90deg,#007f00,#00cc44); color:#fff; }
.cancel { background:#eee; color:#222; }

/* small note */
.small { font-size:0.88rem; color:#666; }
/* Estilos para el flujo paso a paso */
#currentCardTitle {
  color: #005600;
  margin-bottom: 5px;
}

#progressText {
  color: #666;
  font-style: italic;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Mejorar visualización de inputs */
input[type="date"], select {
  font-family: 'Orbitron', sans-serif;
  border: 1px solid #ccc;
  transition: border-color 0.3s;
}

input[type="date"]:focus, select:focus {
  border-color: #007f00;
  outline: none;
  box-shadow: 0 0 0 2px rgba(0, 127, 0, 0.2);
}

/* Estilo para mensajes */
#resultMsg {
  padding: 10px;
  border-radius: 8px;
  background-color: #f8f9fa;
  min-height: 40px;
}

/* Animación suave entre tarjetas */
.card {
  animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>
  <header>
    <div id="menuContainer"></div>
    <h1>Completar Tarjetas - Golftrix</h1>
    <img src="logo_golftrix.png" alt="Logo" id="logo" />
</header>
<div class="container">
  <!-- Estado y progreso -->
  <div id="statusLine" class="small" style="text-align: center; margin-bottom: 15px;"></div>
  
  <div style="text-align: center; margin-bottom: 15px;">
    <div id="missingBadge" class="badge" style="display: none; margin: 0 auto;"></div>
  </div>

  <!-- Indicador de tarjeta actual -->
  <div style="text-align: center; margin-bottom: 20px;">
    <h3 id="currentCardTitle">Tarjeta 1 de <span id="totalCards">0</span></h3>
    <div class="small" id="progressText">Completa los datos de la tarjeta</div>
  </div>

  <!-- Formulario de tarjeta actual (solo una visible) -->
  <div id="currentCardContainer">
    <!-- Los inputs se generarán aquí dinámicamente -->
  </div>

  <!-- Navegación -->
  <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
    <button id="prevBtn" class="btn cancel" style="display: none;">
      <i class="fas fa-arrow-left"></i> Atrás
    </button>
    
    <button id="nextBtn" class="btn save">
      Siguiente <i class="fas fa-arrow-right"></i>
    </button>
    
    <button id="saveFinalBtn" class="btn save" style="display: none;">
      <i class="fas fa-save"></i> Guardar y Calcular Handicap
    </button>
  </div>

  <!-- Mensajes de resultado -->
  <div id="resultMsg" style="margin-top: 20px; text-align: center;" class="small"></div>
</div>

<footer style="background: #000; color: white; text-align: center; padding: 15px;">
  &copy; 2025 Golftrix. Todos los derechos reservados.
</footer>

<script>
function getQueryParam(n){ const u=new URL(location.href); return u.searchParams.get(n); }
</script>

<script type="module">
import { app, db } from './firebase-config.js';
import { calculateAndSaveHandicap } from './handicap.js'; // importa el módulo anterior
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection,
  query,
  where,
  orderBy,
  getDocs,
  addDoc,
  serverTimestamp,
  doc,
  setDoc,
  getDoc,
  limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const auth = getAuth(app);

// Agregar evento click al logo para ir al dashboard
const logo = document.getElementById('logo');
if (logo) {
  logo.addEventListener('click', () => window.location.href = 'dashboard.html');
}

let campos = []; // lista de camposGolf
// VARIABLES NUEVAS PARA EL FLUJO POR PASOS
let currentCardIndex = 0; // Índice de tarjeta actual (0-based)
let maxCardsToFill = 0;   // Número de tarjetas a llenar
let tempEntries = [];     // Datos de todas las tarjetas
let salidaOptions = ['Blancas', 'Azules', 'Rojas']; // Opciones de salida

// Referencias DOM NUEVAS
const currentCardContainer = document.getElementById('currentCardContainer');
const currentCardTitle = document.getElementById('currentCardTitle');
const totalCardsSpan = document.getElementById('totalCards');
const progressText = document.getElementById('progressText');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const saveFinalBtn = document.getElementById('saveFinalBtn');
const missingBadge = document.getElementById('missingBadge');
const statusLine = document.getElementById('statusLine');
const resultMsg = document.getElementById('resultMsg');

function openModal() {
  modalRoot.style.display = 'flex';
}
function closeModal() {
  modalRoot.style.display = 'none';
}

// cargar campos de golf
async function loadCampos() {
  campoSelect.innerHTML = '<option value="">Cargando campos...</option>';
  const q = query(collection(db, 'camposGolf'), orderBy('nombre'));
  const snap = await getDocs(q);
  campos = [];
  snap.forEach(s => {
    const d = s.data();
    campos.push({ id: s.id, nombre: d.nombre });
  });
  campoSelect.innerHTML = '<option value="">-- Selecciona campo --</option>';
  campos.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.nombre;
    campoSelect.appendChild(opt);
  });
}

// calcula cuántas tarjetas completas tiene el usuario
async function countUserCompleteCards(uid) {
  // traemos tarjetas ownerUid==uid y filtramos por 18 hoyos completos
  // para eficiencia limitamos a 50
  const q = query(collection(db, 'tarjetas'), where('ownerUid', '==', uid), orderBy('createdAtMillis', 'desc'), limit(50));
  const snap = await getDocs(q);
  let count = 0;
  snap.forEach(snapDoc => {
    const d = snapDoc.data();
    if (d?.scores && Array.isArray(d.scores) && d.scores.length >= 18) {
      // chequeo simple: que existan hoyos 1..18
      const set = new Set(d.scores.map(x => x.hoyo));
      let ok = true;
      for (let i = 1; i <= 18; i++) { if (!set.has(i)) { ok = false; break; } }
      if (ok) count++;
    }
  });
  return count;
}

// genera botones de tarjeta 1..N
function renderCountButtons(maxMissing) {
  countButtons.innerHTML = '';
  for (let i = 1; i <= maxMissing; i++) {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'count-btn';
    btn.textContent = `Tarjeta ${i}`;
    btn.dataset.index = i;
    btn.addEventListener('click', () => {
      selectedCount = i;
      renderCardInputs();
      // marcar seleccion
      Array.from(countButtons.children).forEach(ch => ch.style.boxShadow = '');
      btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)';
    });
    countButtons.appendChild(btn);
  }
  // seleccionar por defecto 1
  if (maxMissing > 0) {
    selectedCount = 1;
    countButtons.firstChild.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)';
  } else {
    selectedCount = 0;
  }
}

// Renderiza solo la tarjeta actual
function renderCurrentCard() {
  const entry = tempEntries[currentCardIndex] || { fecha: '', campoId: '', salida: '', scores: {} };
  
  // Si es tarjeta 2 o superior, propagar valores de la anterior si están vacíos
  if (currentCardIndex > 0) {
    const prevEntry = tempEntries[currentCardIndex - 1];
    if (!entry.fecha && prevEntry.fecha) entry.fecha = prevEntry.fecha;
    if (!entry.campoId && prevEntry.campoId) entry.campoId = prevEntry.campoId;
    if (!entry.salida && prevEntry.salida) entry.salida = prevEntry.salida;
  }
  
  currentCardContainer.innerHTML = `
    <div class="card">
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:15px;">
        <strong>Tarjeta ${currentCardIndex + 1}</strong>
        <div class="small">Fecha: <input type="date" id="fechaInput" value="${entry.fecha || ''}" /></div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label class="small">Campo de golf</label>
        <select id="campoSelectInput" class="select">
          <option value="">-- Selecciona campo --</option>
          ${campos.map(c => `<option value="${c.id}" ${entry.campoId === c.id ? 'selected' : ''}>${c.nombre}</option>`).join('')}
        </select>
      </div>
      
      <div style="margin-bottom:15px;">
        <label class="small">Salida</label>
        <select id="salidaSelectInput" class="select">
          <option value="">-- Selecciona salida --</option>
          ${salidaOptions.map(s => `<option value="${s}" ${entry.salida === s ? 'selected' : ''}>${s}</option>`).join('')}
        </select>
      </div>
      
      <div style="margin-top:20px;">
        <div class="small" style="margin-bottom:10px; font-weight:bold; text-align:center;">
          Ingresa los scores para los 18 hoyos:
        </div>
        <div class="hoyos-grid" id="hoyosGrid"></div>
      </div>
    </div>
  `;
  
  // Hoyos grid
  const grid = document.getElementById('hoyosGrid');
  grid.innerHTML = '';
  
  for (let i = 1; i <= 18; i++) {
    const val = entry.scores && typeof entry.scores[i] !== 'undefined' ? entry.scores[i] : '';
    const div = document.createElement('div');
    div.className = 'hoyo-card';
    div.innerHTML = `
      <label>Hoyo ${i}</label>
      <input type="number" min="0" max="20" id="hoyo-${i}" value="${val}" />
    `;
    grid.appendChild(div);
    
    const inp = div.querySelector('input');
    inp.addEventListener('input', (e) => {
      const v = e.target.value;
      tempEntries[currentCardIndex].scores[i] = v === '' ? undefined : Number(v);
    });
  }
  
  // Eventos para fecha y selects
  document.getElementById('fechaInput').addEventListener('change', (e) => {
    tempEntries[currentCardIndex].fecha = e.target.value;
  });
  
  document.getElementById('campoSelectInput').addEventListener('change', (e) => {
    tempEntries[currentCardIndex].campoId = e.target.value;
  });
  
  document.getElementById('salidaSelectInput').addEventListener('change', (e) => {
    tempEntries[currentCardIndex].salida = e.target.value;
  });
  
  // Actualizar título
  currentCardTitle.textContent = `Tarjeta ${currentCardIndex + 1} de ${maxCardsToFill}`;
}

// Actualiza visibilidad y estado de botones de navegación
function updateNavigationButtons() {
  // Botón Atrás
  prevBtn.style.display = currentCardIndex > 0 ? 'inline-block' : 'none';
  
  // Botón Siguiente vs Guardar Final
  if (currentCardIndex === maxCardsToFill - 1) {
    // Última tarjeta
    nextBtn.style.display = 'none';
    saveFinalBtn.style.display = 'inline-block';
    progressText.textContent = 'Última tarjeta. Verifica los datos y guarda.';
  } else {
    // No es la última
    nextBtn.style.display = 'inline-block';
    saveFinalBtn.style.display = 'none';
    progressText.textContent = `Completa los datos de la tarjeta ${currentCardIndex + 1}`;
  }
  
  // Validar si la tarjeta actual está completa
  validateCurrentCard();
}

// Valida si la tarjeta actual tiene todos los datos necesarios
function validateCurrentCard() {
  const entry = tempEntries[currentCardIndex];
  let isValid = true;
  let message = '';
  
  // Validar fecha
  if (!entry.fecha) {
    isValid = false;
    message = 'La fecha es requerida';
  }
  
  // Validar 18 hoyos
  if (isValid) {
    for (let i = 1; i <= 18; i++) {
      if (typeof entry.scores[i] !== 'number' || Number.isNaN(entry.scores[i])) {
        isValid = false;
        message = `Falta el hoyo ${i}`;
        break;
      }
    }
  }
  
  // Actualizar estado del botón siguiente
  nextBtn.disabled = !isValid;
  saveFinalBtn.disabled = !isValid;
  
  // Mostrar mensaje de validación
  if (!isValid && message) {
    resultMsg.textContent = `⚠️ ${message}`;
    resultMsg.style.color = '#d32f2f';
  } else {
    resultMsg.textContent = '';
  }
  
  return isValid;
}

// guardar tarjetas creadas por el usuario en firestore
// guardar todas las tarjetas creadas por el usuario en firestore
async function saveAllCardsAndRecalc(uid) {
  resultMsg.textContent = 'Validando tarjetas...';
  resultMsg.style.color = '#006400';
  
  // Validar todas las tarjetas
  for (let t = 0; t < maxCardsToFill; t++) {
    const e = tempEntries[t];
    
    // Validar fecha
    if (!e.fecha) {
      resultMsg.textContent = `La tarjeta ${t+1} no tiene fecha.`;
      resultMsg.style.color = '#d32f2f';
      return;
    }
    
    // Validar 18 hoyos
    for (let i = 1; i <= 18; i++) {
      if (typeof e.scores[i] !== 'number' || Number.isNaN(e.scores[i])) {
        resultMsg.textContent = `La tarjeta ${t+1} no tiene el hoyo ${i} completo.`;
        resultMsg.style.color = '#d32f2f';
        return;
      }
    }
  }

  resultMsg.textContent = 'Guardando tarjetas...';
  
  // crear cada documento en collection 'tarjetas'
  const col = collection(db, 'tarjetas');
  try {
    for (let t = 0; t < maxCardsToFill; t++) {
      const e = tempEntries[t];
      
      // construir array scores
      const scoresArray = [];
      const nowMillis = Date.now();
      for (let i = 1; i <= 18; i++) {
        scoresArray.push({
          hoyo: i,
          golpes: Number(e.scores[i]),
          createdAtMillis: nowMillis
        });
      }

      // Obtener nombre del campo
      const campoNombre = campos.find(c => c.id === e.campoId)?.nombre || '';
      
      const docPayload = {
        campoId: e.campoId || '',
        campoNombre: campoNombre,
        salida: e.salida || '', // NUEVO: campo de salida
        createdAt: e.fecha ? new Date(e.fecha) : serverTimestamp(),
        createdAtMillis: e.fecha ? new Date(e.fecha).getTime() : Date.now(),
        estado: 'activa',
        ownerUid: uid,
        userUid: uid,
        scores: scoresArray,
        lastUpdated: serverTimestamp()
      };

      await addDoc(col, docPayload);
    }

    resultMsg.textContent = `${maxCardsToFill} tarjetas guardadas. Calculando handicap...`;

    // recalcular y guardar handicap
    const res = await calculateAndSaveHandicap(uid);
    if (res.ok && res.saved) {
      resultMsg.textContent = `✅ Handicap calculado y guardado: ${res.handicap}`;
      resultMsg.style.color = '#006400';
      
      // Opcional: redirigir después de 3 segundos
      setTimeout(() => {
        window.location.href = 'dashboard.html';
      }, 3000);
      
    } else if (res.ok && !res.saved) {
      resultMsg.textContent = `ℹ️ Handicap calculado: ${res.handicap} (no se pudo guardar automáticamente).`;
      resultMsg.style.color = '#ff9800';
    } else {
      if (res.missing) {
        resultMsg.textContent = `⚠️ Aún faltan ${res.missing} tarjetas para calcular handicap.`;
        resultMsg.style.color = '#ff9800';
      } else {
        resultMsg.textContent = `❌ Error: ${res.message || 'No se pudo calcular el handicap.'}`;
        resultMsg.style.color = '#d32f2f';
      }
    }
    
  } catch (err) {
    console.error('Error guardando tarjetas:', err);
    resultMsg.textContent = '❌ Error guardando tarjetas. Revisa la consola.';
    resultMsg.style.color = '#d32f2f';
  }
}

// flujo inicial: contar tarjetas y preparar vista
async function prepareFormForUser(uid) {
  statusLine.textContent = 'Consultando tarjetas y campos...';
  resultMsg.textContent = '';
  
  await loadCampos();
  const count = await countUserCompleteCards(uid);
  availableCardsCount = count;
  missingCount = Math.max(0, 10 - availableCardsCount);
  
  // Mostrar estado
  missingBadge.style.display = missingCount > 0 ? 'inline-block' : 'none';
  missingBadge.textContent = missingCount > 0 ? 
    `Te hacen falta ${missingCount} tarjetas para calcular handicap` : 
    'Tienes 10 o más tarjetas';
  
  statusLine.textContent = `Tarjetas completas encontradas: ${availableCardsCount}`;
  
  // Determinar cuántas tarjetas mostrar
  maxCardsToFill = missingCount > 0 ? missingCount : 1;
  totalCardsSpan.textContent = maxCardsToFill;
  
  // Inicializar estructura de datos
  tempEntries = [];
  for (let i = 0; i < maxCardsToFill; i++) {
    tempEntries[i] = { 
      fecha: '', 
      campoId: '', 
      salida: '',  // NUEVO: campo de salida
      scores: {} 
    };
  }
  
  // Mostrar primera tarjeta
  currentCardIndex = 0;
  renderCurrentCard();
  updateNavigationButtons();
}

// Esta función reemplaza a prepareModalForUser
// También eliminar la función openModal() y closeModal() ya que no usamos modal

// Eventos de navegación
prevBtn.addEventListener('click', () => {
  if (currentCardIndex > 0) {
    currentCardIndex--;
    renderCurrentCard();
    updateNavigationButtons();
  }
});

nextBtn.addEventListener('click', () => {
  if (validateCurrentCard()) {
    if (currentCardIndex < maxCardsToFill - 1) {
      currentCardIndex++;
      renderCurrentCard();
      updateNavigationButtons();
    }
  }
});

saveFinalBtn.addEventListener('click', async () => {
  if (!currentUserUid) {
    resultMsg.textContent = 'No hay usuario autenticado.';
    return;
  }
  
  if (validateCurrentCard()) {
    await saveAllCardsAndRecalc(currentUserUid);
  }
});

// Al cargar la página, iniciar el formulario
document.addEventListener('DOMContentLoaded', async () => {
  const user = auth.currentUser;
  if (!user) {
    // Redirigir a login si no está autenticado
    window.location.href = 'index.html';
    return;
  }
  
  currentUserUid = user.uid;
  await prepareFormForUser(currentUserUid);
});

// Si el usuario no estaba autenticado al presionar abrir, actualizamos al hacer login
onAuthStateChanged(auth, async (u) => {
  if (u) {
    currentUserUid = u.uid;
    // Recargar el formulario si ya está en la página
    if (document.readyState === 'complete') {
      await prepareFormForUser(currentUserUid);
    }
  } else {
    currentUserUid = null;
    window.location.href = 'index.html';
  }
});
</script>

<script>
  // Carga menu.html, extrae botón hamburguesa y sidebar, los inserta y luego carga la lógica (menu.js)
  fetch('menu.html')
    .then(res => res.text())
    .then(html => {
      const temp = document.createElement('div');
      temp.innerHTML = html;

      // buscar botón hamburguesa (por id o por clase)
      const hamburgerBtn = temp.querySelector('#hamburger') || temp.querySelector('.hamburger');
      // buscar sidebar (por id o clase)
      const sidebarMenu = temp.querySelector('#sidebarMenu') || temp.querySelector('.sidebar-mobile') || temp.querySelector('.sidebar');

      // coloca el botón hamburger dentro del header (en #menuContainer)
      const container = document.getElementById('menuContainer');
      if (hamburgerBtn && container) {
        container.appendChild(hamburgerBtn);
      }

      // coloca el sidebar al final del body (fuera del header) para que su posicionamiento fijo funcione
      if (sidebarMenu) {
        document.body.appendChild(sidebarMenu);
      }

      // ahora que los nodos están en el DOM, carga la lógica del menú
      import('./menu.js').catch(err => console.error('Error importando menu.js', err));
    })
    .catch(err => {
      console.error('Error cargando menu.html', err);
    });
</script>

</body>
</html>
