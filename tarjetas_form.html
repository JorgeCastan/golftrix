<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Completar Tarjetas - Golftrix</title>
<link rel="icon" href="logo_golftrix.png" type="image/png" />
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="menu.css" />
<style>
/* Reutiliza estilos similares a tarjeta.html */
body { 
  font-family:'Orbitron',sans-serif; 
  margin:0; 
  padding:0;  /* CAMBIADO: quitar padding general */
  background: #f6f6f6; 
  color:#111;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* NUEVO: HEADER ESTILO GOLFTRIX */
  header {
      background: linear-gradient(90deg, #007f00, #00cc44);
      display: flex;
      align-items: center;
      justify-content: center; /* Para centrar el título horizontalmente */
      position: relative;
      padding: 20px 40px;
      color: white;
      height: 80px; /* para dar altura fija */
    }

    /* Título centrado absoluto */
    header h1 {
      font-size: 2rem;
      margin: 0;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    /* Logo a la derecha, grande */
    header img {
      height: 100px;
      position: absolute;
      right: 20px;
      cursor: pointer;
    }

/* Ajustes para móvil */
@media (max-width: 768px) {
  header {
    flex-direction: column;
    height: auto;
    padding: 20px;
    position: static;
  }

  header img {
    position: static;
    height: 60px;
    order: 1;
    margin-bottom: 10px;
  }

  header h1 {
    position: static;
    order: 2;
    transform: none;
    font-size: 1.8rem;
  }
}

.container { 
  max-width:1000px; 
  margin:0 auto; 
  padding: 20px 12px; /* AGREGAR padding aquí en vez de en body */
  flex: 1;
}

/* Modal */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.45);
  display:flex; align-items:center; justify-content:center; z-index:1000;
}
.modal {
  width: 100%; max-width: 980px; background:white; border-radius:12px; padding:14px;
  box-shadow:0 8px 28px rgba(0,0,0,0.25); max-height:90vh; overflow:auto;
}
h2 { margin:0 0 10px 0; color:#005600; text-align:center; }

/* grid principal */
.top-row { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; }
.badge { background:#eaf9ea; color:#006400; padding:6px 10px; border-radius:10px; font-weight:800; }

/* botones de seleccion de numero de tarjetas */
.select-count { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px; }
.count-btn { padding:8px 12px; border-radius:8px; border:2px solid transparent; background:linear-gradient(90deg,#f0f0f0,#fff); cursor:pointer; font-weight:800; }

/* campo select */
.field { margin-bottom:10px; }
.select { width:100%; padding:8px; border-radius:8px; height:40px; }

/* Tarjetas area */
.cards-list { display:flex; flex-direction:column; gap:12px; }

/* Cada tarjeta a crear */
.card { background:#fafafa; padding:10px; border-radius:10px; }

/* Hoyos grid: 2 columnas desktop, 1 en móvil */
.hoyos-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; }
@media (max-width:700px) {
  .hoyos-grid { grid-template-columns: 1fr; }
}
.hoyo-card { background:#fff; padding:6px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.04); text-align:center; }
.hoyo-card label { display:block; font-weight:700; margin-bottom:4px; font-size:0.85rem; }
.hoyo-card input { width:100%; padding:6px; height:36px; border-radius:6px; text-align:center; }

/* botones */
.btn { padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800; border:none; }
.save { background: linear-gradient(90deg,#007f00,#00cc44); color:#fff; }
.cancel { background:#eee; color:#222; }

/* small note */
.small { font-size:0.88rem; color:#666; }
</style>
</head>
<body>
  <header>
    <div id="menuContainer"></div>
    <h1>Completar Tarjetas - Golftrix</h1>
    <img src="logo_golftrix.png" alt="Logo" id="logo" />
</header>
<div class="container">
  <!-- La UI ahora se mostrará automáticamente; no hace falta botón -->
  <div style="text-align:center; margin-bottom:8px;">
    <!-- Mensaje opcional: instrucciones -->
    <div class="small">Completa las tarjetas solicitadas. Usa Siguiente / Atrás para navegar. En la última tarjeta presiona Guardar.</div>
  </div>
</div>

<!-- Modal (hidden initially) -->
<div id="modalRoot" style="display:none;" class="modal-overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="top-row">
      <h2>Completar Tarjetas para Handicap</h2>
      <div><button id="closeModal" class="btn cancel">Cerrar</button></div>
    </div>

    <div id="statusLine" class="small">Consultando tarjetas...</div>

    <div style="margin-top:8px;">
      <div id="missingBadge" class="badge" style="display:none;"></div>
      <div class="small" style="margin:6px 0;">Selecciona la cantidad de tarjetas a llenar:</div>
      <div id="countButtons" class="select-count"></div>
    </div>

    <div style="margin-top:10px;">
      <label class="small">Selecciona campo</label>
      <select id="campoSelect" class="select"></select>
    </div>

    <div id="cardsContainer" class="cards-list"></div>

    <div style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
      <button id="prevBtn" class="btn cancel" type="button" style="display:none;">Atrás</button>
      <button id="nextBtn" class="btn save" type="button">Siguiente</button>
    </div>

    <div id="resultMsg" style="margin-top:12px;" class="small"></div>
  </div>
</div>

<footer style="background: #000; color: white; text-align: center; padding: 15px;">
  &copy; 2025 Golftrix. Todos los derechos reservados.
</footer>

<script>
function getQueryParam(n){ const u=new URL(location.href); return u.searchParams.get(n); }
</script>

<script type="module">
import { app, db } from './firebase-config.js';
import { calculateAndSaveHandicap } from './handicap.js'; // importa el módulo anterior
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection,
  query,
  where,
  orderBy,
  getDocs,
  addDoc,
  serverTimestamp,
  doc,
  setDoc,
  getDoc,
  limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const auth = getAuth(app);

// Agregar evento click al logo para ir al dashboard
const logo = document.getElementById('logo');
if (logo) {
  logo.addEventListener('click', () => window.location.href = 'dashboard.html');
}

// DOM
const openModalBtn = document.getElementById('openModal');
const modalRoot = document.getElementById('modalRoot');
const closeModalBtn = document.getElementById('closeModal');
const countButtons = document.getElementById('countButtons');
const campoSelect = document.getElementById('campoSelect');
const cardsContainer = document.getElementById('cardsContainer');
const saveCardsBtn = document.getElementById('saveCardsBtn');
const cancelBtn = document.getElementById('cancelBtn');
const missingBadge = document.getElementById('missingBadge');
const statusLine = document.getElementById('statusLine');
const resultMsg = document.getElementById('resultMsg');

let currentUserUid = null;
let availableCardsCount = 0;
let missingCount = 0;
// selectedCount ya no controla la UI paginada; lo dejamos por compatibilidad pero no se usa para render
let selectedCount = 0;
let campos = []; // lista de camposGolf

// flags para navegación por tarjetas
let totalToFill = 0;     // cuántas tarjetas hay que rellenar (missingCount)
let currentIndex = 0;    // índice de la tarjeta que se está editando (0-based)

// estructura para mantener datos de input sin perderlos al cambiar tarjeta
// será un array: tempEntries[i] = { fecha:'', campoId:'', salida:'Blancas'|'Azules'|'Rojas', scores: {1:val,...,18:val} }
const tempEntries = [];

function openModal() {
  modalRoot.style.display = 'flex';
}
function closeModal() {
  modalRoot.style.display = 'none';
}

// cargar campos de golf
async function loadCampos() {
  campoSelect.innerHTML = '<option value="">Cargando campos...</option>';
  const q = query(collection(db, 'camposGolf'), orderBy('nombre'));
  const snap = await getDocs(q);
  campos = [];
  snap.forEach(s => {
    const d = s.data();
    campos.push({ id: s.id, nombre: d.nombre });
  });
  campoSelect.innerHTML = '<option value="">-- Selecciona campo --</option>';
  campos.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.nombre;
    campoSelect.appendChild(opt);
  });
}

// calcula cuántas tarjetas completas tiene el usuario
async function countUserCompleteCards(uid) {
  // traemos tarjetas ownerUid==uid y filtramos por 18 hoyos completos
  // para eficiencia limitamos a 50
  const q = query(collection(db, 'tarjetas'), where('ownerUid', '==', uid), orderBy('createdAtMillis', 'desc'), limit(50));
  const snap = await getDocs(q);
  let count = 0;
  snap.forEach(snapDoc => {
    const d = snapDoc.data();
    if (d?.scores && Array.isArray(d.scores) && d.scores.length >= 18) {
      // chequeo simple: que existan hoyos 1..18
      const set = new Set(d.scores.map(x => x.hoyo));
      let ok = true;
      for (let i = 1; i <= 18; i++) { if (!set.has(i)) { ok = false; break; } }
      if (ok) count++;
    }
  });
  return count;
}

// genera botones de tarjeta 1..N
// Ya no usamos los botones 1..N; esta función queda preservada pero vacía
function renderCountButtons(maxMissing) {
  // preservamos compatibilidad, pero la UI se controla con currentIndex/totalToFill y los botones Atrás/Siguiente
  countButtons.innerHTML = '';
}


// render de inputs para N tarjetas (no borra datos previos)
// Renderiza SOLO la tarjeta con índice `index` (0-based)
function renderSingleCard(index) {
  // asegurar entrada inicial
  if (!tempEntries[index]) {
    tempEntries[index] = { fecha: '', campoId: '', salida: '', scores: {} };
  }
  const entry = tempEntries[index];

  // limpiar contenedor
  cardsContainer.innerHTML = '';

  // crear tarjeta
  const cardDiv = document.createElement('div');
  cardDiv.className = 'card';
  cardDiv.innerHTML = `
    <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
      <strong>Tarjeta ${index+1} de ${totalToFill}</strong>
      <div class="small">Fecha: <input type="date" id="fecha-${index}" /></div>
    </div>

    <div style="margin-top:8px;">
      <label class="small">Campo (opcional)</label>
      <select id="campo-${index}" class="select"></select>
    </div>

    <div style="margin-top:8px;">
      <label class="small">Salida</label>
      <select id="salida-${index}" class="select">
        <option value="">-- Selecciona salida --</option>
        <option value="Blancas">Blancas</option>
        <option value="Azules">Azules</option>
        <option value="Rojas">Rojas</option>
      </select>
    </div>

    <div style="margin-top:8px;">
      <div class="hoyos-grid" id="grid-${index}"></div>
    </div>
  `;

  cardsContainer.appendChild(cardDiv);

  // fecha
  const fechaInput = cardDiv.querySelector(`#fecha-${index}`);
  fechaInput.value = entry.fecha || '';
  fechaInput.addEventListener('change', (e) => { tempEntries[index].fecha = e.target.value; });

  // campo select
  const campoSel = cardDiv.querySelector(`#campo-${index}`);
  campoSel.innerHTML = '<option value="">-- Selecciona campo --</option>';
  campos.forEach(c => {
    const o = document.createElement('option');
    o.value = c.id;
    o.textContent = c.nombre;
    campoSel.appendChild(o);
  });
  if (entry.campoId) campoSel.value = entry.campoId;
  campoSel.addEventListener('change', (e) => { tempEntries[index].campoId = e.target.value; });

  // salida select
  const salidaSel = cardDiv.querySelector(`#salida-${index}`);
  // si no hay valor y existe la primera tarjeta con salida, heredarla
  if (!entry.salida && tempEntries[0] && tempEntries[0].salida) {
    entry.salida = tempEntries[0].salida;
  }
  if (entry.salida) salidaSel.value = entry.salida;
  salidaSel.addEventListener('change', (e) => {
    tempEntries[index].salida = e.target.value;
    // si index == 0, propagar a los siguientes que aún no tengan valor
    if (index === 0) {
      for (let i = 1; i < totalToFill; i++) {
        if (!tempEntries[i]) tempEntries[i] = { fecha: '', campoId: '', salida: '', scores: {} };
        if (!tempEntries[i].salida) tempEntries[i].salida = e.target.value;
      }
    }
  });

  // hoyos grid
  const grid = cardDiv.querySelector(`#grid-${index}`);
  grid.innerHTML = '';
  for (let i = 1; i <= 18; i++) {
    const val = (entry.scores && typeof entry.scores[i] !== 'undefined') ? entry.scores[i] : '';
    const div = document.createElement('div');
    div.className = 'hoyo-card';
    div.innerHTML = `
      <label>Hoyo ${i}</label>
      <input type="number" min="0" id="h-${index}-${i}" value="${val}" />
    `;
    grid.appendChild(div);
    const inp = div.querySelector(`#h-${index}-${i}`);
    inp.addEventListener('input', (e) => {
      const v = e.target.value;
      if (!tempEntries[index].scores) tempEntries[index].scores = {};
      tempEntries[index].scores[i] = (v === '') ? undefined : Number(v);
    });
  }

  // actualizar estado de botones de navegación
  updateNavButtons();
}

function updateNavButtons() {
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  if (!prevBtn || !nextBtn) return;

  prevBtn.style.display = (currentIndex > 0) ? 'inline-flex' : 'none';

  // si estamos en la última tarjeta
  if (currentIndex >= totalToFill - 1) {
    nextBtn.textContent = 'Guardar';
  } else {
    nextBtn.textContent = 'Siguiente';
  }
}

// navegar a la siguiente tarjeta (o guardar si es la última)
async function nextCard() {
  // validación básica: no permitir avanzar si faltan datos en la tarjeta actual
  const e = tempEntries[currentIndex] || {};
  // comprobar que los 18 hoyos estén completados (número) y fecha no vacía
  let ok = true;
  if (!e.fecha) ok = false;
  for (let i = 1; i <= 18; i++) {
    if (typeof e.scores?.[i] !== 'number' || Number.isNaN(e.scores[i])) { ok = false; break; }
  }
  if (!ok) {
    resultMsg.textContent = `La tarjeta ${currentIndex+1} no está completa. Completa fecha y los 18 hoyos antes de continuar.`;
    return;
  }
  resultMsg.textContent = '';

  if (currentIndex < totalToFill - 1) {
    currentIndex++;
    renderSingleCard(currentIndex);
  } else {
    // última tarjeta -> guardar todas
    await saveAllCardsAndRecalc(currentUserUid);
  }
}

// volver a tarjeta anterior
function prevCard() {
  if (currentIndex > 0) {
    currentIndex--;
    renderSingleCard(currentIndex);
  }
}



// guardar tarjetas creadas por el usuario en firestore
// Guarda todas las tarjetas en tempEntries[0..totalToFill-1] y recalcula handicap
async function saveAllCardsAndRecalc(uid) {
  if (!uid) {
    resultMsg.textContent = 'No hay usuario autenticado.';
    return;
  }
  if (totalToFill <= 0) {
    resultMsg.textContent = 'No hay tarjetas para guardar.';
    return;
  }

  // Validación final (ya hicimos validación por tarjeta en nextCard, pero verificamos todo)
  for (let t = 0; t < totalToFill; t++) {
    const e = tempEntries[t];
    if (!e || !e.fecha) {
      resultMsg.textContent = `La tarjeta ${t+1} falta fecha u otros datos.`;
      return;
    }
    for (let i = 1; i <= 18; i++) {
      if (typeof e.scores?.[i] !== 'number' || Number.isNaN(e.scores[i])) {
        resultMsg.textContent = `La tarjeta ${t+1} no tiene el hoyo ${i} completado.`;
        return;
      }
    }
  }

  resultMsg.textContent = 'Guardando tarjetas...';
  const col = collection(db, 'tarjetas');

  try {
    for (let t = 0; t < totalToFill; t++) {
      const e = tempEntries[t];
      const scoresArray = [];
      const nowMillis = Date.now();
      for (let i = 1; i <= 18; i++) {
        scoresArray.push({
          hoyo: i,
          golpes: Number(e.scores[i]),
          createdAtMillis: nowMillis
        });
      }

      const docPayload = {
        campoId: e.campoId || '',
        campoNombre: (campos.find(c=>c.id===e.campoId)?.nombre) || '',
        salida: e.salida || '',
        createdAt: e.fecha ? new Date(e.fecha) : serverTimestamp(),
        createdAtMillis: e.fecha ? new Date(e.fecha).getTime() : nowMillis,
        estado: 'activa',
        ownerUid: uid,
        userUid: uid,
        scores: scoresArray,
        lastUpdated: serverTimestamp()
      };

      await addDoc(col, docPayload);
    }

    resultMsg.textContent = 'Tarjetas guardadas. Calculando handicap...';

    const res = await calculateAndSaveHandicap(uid);
    if (res.ok && res.saved) {
      resultMsg.textContent = `Handicap calculado y guardado: ${res.handicap}`;
    } else if (res.ok && !res.saved) {
      resultMsg.textContent = `Handicap calculado: ${res.handicap} (no se pudo guardar automáticamente).`;
    } else {
      if (res.missing) {
        resultMsg.textContent = `Aún faltan ${res.missing} tarjetas para calcular handicap.`;
      } else {
        resultMsg.textContent = `Error: ${res.message || 'No se pudo calcular el handicap.'}`;
      }
    }

  } catch (err) {
    console.error('Error guardando tarjetas:', err);
    resultMsg.textContent = 'Error guardando tarjetas. Revisa la consola.';
  }
}

// flujo inicial: contar tarjetas y mostrar missing
async function prepareModalForUser(uid) {
  statusLine.textContent = 'Consultando tarjetas y campos...';
  await loadCampos();
  const count = await countUserCompleteCards(uid);
  availableCardsCount = count;
  missingCount = Math.max(0, 10 - availableCardsCount);
  missingBadge.style.display = missingCount > 0 ? 'inline-block' : 'none';
  missingBadge.textContent = missingCount > 0 ? `Te hacen falta ${missingCount} tarjetas` : 'Tienes 10 o más tarjetas';
  statusLine.textContent = `Tarjetas completas encontradas: ${availableCardsCount}`;

  // preparar totalToFill (cuántas tarjetas faltan). Si no faltan, dejamos 1 por defecto para forzar recalculo
  totalToFill = missingCount > 0 ? missingCount : 1;

  // inicializar tempEntries vacías hasta totalToFill
  for (let i = 0; i < totalToFill; i++) {
    if (!tempEntries[i]) tempEntries[i] = { fecha: '', campoId: '', salida: '', scores: {} };
  }

  // Mostrar la primera tarjeta directamente
  currentIndex = 0;
  modalRoot.style.display = 'flex'; // abrir la UI (antes dependía del botón)
  renderSingleCard(currentIndex);
  resultMsg.textContent = '';
}

// Eventos
// Ya no usamos openModalBtn; en su lugar, cuando el usuario esté autenticado prepararemos y mostraremos la UI
// (ver onAuthStateChanged al final del archivo).

closeModalBtn.addEventListener('click', closeModal);
cancelBtn.addEventListener('click', closeModal);

// Guardar tarjetas
saveCardsBtn.addEventListener('click', async () => {
  if (!currentUserUid) {
    resultMsg.textContent = 'No hay usuario autenticado.';
    return;
  }
  await saveNewCardsAndRecalc(currentUserUid);
});

// Si el usuario no estaba autenticado al presionar abrir, actualizamos al hacer login
onAuthStateChanged(auth, async (u) => {
  if (u) {
    currentUserUid = u.uid;
    // preparar modal y mostrar la UI automaticamente
    await prepareModalForUser(currentUserUid);
  } else {
    currentUserUid = null;
    // cerrar modal si el usuario sale
    modalRoot.style.display = 'none';
  }
});

</script>

<script>
  // Carga menu.html, extrae botón hamburguesa y sidebar, los inserta y luego carga la lógica (menu.js)
  fetch('menu.html')
    .then(res => res.text())
    .then(html => {
      const temp = document.createElement('div');
      temp.innerHTML = html;

      // buscar botón hamburguesa (por id o por clase)
      const hamburgerBtn = temp.querySelector('#hamburger') || temp.querySelector('.hamburger');
      // buscar sidebar (por id o clase)
      const sidebarMenu = temp.querySelector('#sidebarMenu') || temp.querySelector('.sidebar-mobile') || temp.querySelector('.sidebar');

      // coloca el botón hamburger dentro del header (en #menuContainer)
      const container = document.getElementById('menuContainer');
      if (hamburgerBtn && container) {
        container.appendChild(hamburgerBtn);
      }

      // coloca el sidebar al final del body (fuera del header) para que su posicionamiento fijo funcione
      if (sidebarMenu) {
        document.body.appendChild(sidebarMenu);
      }

      // ahora que los nodos están en el DOM, carga la lógica del menú
      import('./menu.js').catch(err => console.error('Error importando menu.js', err));
    })
    .catch(err => {
      console.error('Error cargando menu.html', err);
    });

    // enlazar botones de navegación (Atrás / Siguiente)
document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'nextBtn') {
    nextCard();
  } else if (e.target && e.target.id === 'prevBtn') {
    prevCard();
  }
});

</script>

</body>
</html>
